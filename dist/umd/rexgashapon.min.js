!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).rexgashapon={})}(this,(function(t){"use strict";var e;function s(t){if(Array.isArray(t))t.length=0;else for(let e in t)delete t[e]}function i(t,e){var i=Array.isArray(t);if(void 0===e?e=i?[]:{}:s(e),i){e.length=t.length;for(let s=0,i=t.length;s<i;s++)e[s]=t[s]}else for(let s in t)e[s]=t[s];return e}!function(t){t[t.shuffle=0]="shuffle",t[t.random=1]="random"}(e||(e={}));t.Gashapon=class{constructor(t={}){let{mode:s=e.shuffle,reload:i=!0,items:r={},rnd:h}=t;this.items={},this.remainder={},this._list=[],this.result=null,this.setMode(s),this.setReload(i),this.setRND(h),Object.assign(this.items,r)}fromJSON({mode:t=e.shuffle,reload:s=!0,items:r={},result:h=null,remainder:n,rnd:a}){return this.setMode(t),this.setReload(s),this.setRND(a),this.items=i(r,this.items),this._list.length=0,this.result=h,this._restartFlag=!0,this._restartFlag&&this.startGen(),n&&(this.remainder=i(n,this.remainder)),this}toJSON(){return{mode:this.mode,reload:this.reload,rnd:this.rnd,items:this.items,remainder:this.remainder,result:this.result}}setMode(t){return"string"==typeof t&&(t=e[t]),this.mode===t||(this.mode=t,this._restartFlag=!0),this}setReload(t=!0){return this.reload=t,this}setRND(t){return this.rnd=t,this}setItem(t,e){return this.items[t]===e||(this.items[t]=e,this._restartFlag=!0),this}setItems(t={}){return this.items=i(t,this.items),this}removeItem(t){return this.items.hasOwnProperty(t)?(delete this.items[t],this._restartFlag=!0,this):this}removeAllItems(){return s(this.items),this._restartFlag=!0,this}addItem(t,s=1){return this.items.hasOwnProperty(t)||(this.items[t]=0),this.items[t]+=s,this._restartFlag||(this.mode===e.shuffle?this.addRemainItem(t,s):this.resetItemList(this.remainder)),this}putItemBack(t,s=1){return this.mode===e.random||this._restartFlag||!this.items.hasOwnProperty(t)||(this.remainder.hasOwnProperty(t)||(this.remainder[t]=0),this.addRemainItem(t,s,this.items[t])),this}next(t){let s=null;return this._restartFlag&&this.startGen(),void 0===t?this.mode===e.shuffle?(this.resetItemList(this.remainder),s=this.getRndItem(this._list),this.addRemainItem(s,-1)):s=this.getRndItem(this._list):this.remainder.hasOwnProperty(t)?(s=t,this.mode===e.shuffle&&this.addRemainItem(t,-1)):s=null,this.result=s,s}getItems(){return this.items}getRemain(){return this.remainder}getItemCount(t){return this.items.hasOwnProperty(t)?this.items[t]:0}getRemainCount(t){return this.remainder.hasOwnProperty(t)?this.remainder[t]:0}forEachItem(t,e){let s=this.items;for(let i in s){let r;if(r=e?t.call(e,i,s[i]):t(i,s[i]),r)break}return this}forEachRemain(t,e){let s=this.remainder;for(let i in s){let r;if(r=e?t.call(e,i,s[i]):t(i,s[i]),r)break}return this}destroy(){s(this.items),s(this.remainder),s(this._list),this.result=null,this._restartFlag=!1}startGen(){for(let t in this.remainder)this.items.hasOwnProperty(t)||delete this.remainder[t];for(let t in this.items){let e=this.items[t];e>0&&(this.remainder[t]=e)}return this.mode===e.random&&this.resetItemList(this.remainder),this._restartFlag=!1,this}resetItemList(t){this._list.length=0;let e=0;for(let s in t){let i=t[s];i>0&&(e+=i)}for(let s in t){let i=t[s];i>0&&this._list.push([s,i/e])}return this}addRemainItem(t,s=1,i){return 0===s||(this.remainder.hasOwnProperty(t)||(this.remainder[t]=0),this.remainder[t]+=s,void 0!==i&&this.remainder[t]>i&&(this.remainder[t]=i),this.remainder[t]<=0&&delete this.remainder[t],this.mode===e.shuffle&&this.reload&&function(t){if(Array.isArray(t))return 0===t.length;for(let e in t)return!1;return!0}(this.remainder)&&(this._restartFlag=!0)),this}getRndItem(t){let e,s=this.rnd?this.rnd.frac():Math.random(),i=null;for(let r=0,h=t.length;r<h;r++)if(e=t[r],s-=e[1],s<0){i=e[0];break}return i}}}));
