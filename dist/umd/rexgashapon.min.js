!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).rexgashapon={})}(this,(function(t){"use strict";var e;!function(t){t[t.shuffle=0]="shuffle",t[t.random=1]="random"}(e||(e={}));let s=function(t,e=new Map){for(let s in t)e.set(s,t[s]);return e},i=function(t,e={}){return t.forEach((t,s)=>e[s]=t),e};let r=function(t){let e=0;for(const[s,i]of t)e+=i;return e};t.Gashapon=class{constructor({mode:t=e.shuffle,reload:s=!0,items:i={},rnd:r}={}){this.items=new Map,this.remainder=new Map,this._totalRemainderCount=null,this.result=null,this.setMode(t),this.setReload(s),this.setRND(r),this.setItems(i)}fromJSON({mode:t=e.shuffle,reload:i=!0,items:r={},result:h=null,remainder:n,rnd:a}={}){return this.setMode(t),this.setReload(i),this.setRND(a),this.setItems(r),this._totalRemainderCount=null,this.result=h,this._restartFlag=!0,this._restartFlag&&this.startGen(),n&&(this.remainder.clear(),s(n,this.remainder)),this}toJSON(){return{mode:this.mode,reload:this.reload,rnd:this.rnd,items:i(this.items),remainder:i(this.remainder),result:this.result}}setMode(t){return"string"==typeof t&&(t=e[t]),this.mode===t||(this.mode=t,this._restartFlag=!0),this}setReload(t=!0){return this.reload=t,this}setRND(t){return this.rnd=t,this}setItem(t,e){return this.items.has(t)&&this.items.get(t)===e||(this.items.set(t,e),this._restartFlag=!0),this}setItems(t={}){return this.items.clear(),s(t,this.items),this._restartFlag=!0,this}removeItem(t){return this.items.has(t)?(this.items.delete(t),this._restartFlag=!0,this):this}removeAllItems(){return this.items.clear(),this._restartFlag=!0,this}addItem(t,s=1){return this.items.has(t)?this.items.set(t,this.items.get(t)+s):this.items.set(t,s),this._restartFlag||(this.mode===e.shuffle?this.addRemainItem(t,s):this._totalRemainderCount=null),this}putItemBack(t,s=1){return this.mode===e.random||this._restartFlag||!this.items.has(t)||this.addRemainItem(t,s,this.items[t]),this}next(t){let s=null;return this._restartFlag&&this.startGen(),void 0===t?this.mode===e.shuffle?(this._totalRemainderCount=null,s=this.getRndItem(),this.addRemainItem(s,-1)):s=this.getRndItem():this.remainder.has(t)?(s=t,this.mode===e.shuffle&&this.addRemainItem(t,-1)):s=null,this.result=s,s}getItems(){return i(this.items)}getRemain(){return i(this.remainder)}getItemCount(t){return this.items.has(t)?this.items.get(t):0}getRemainCount(t){return this.remainder.has(t)?this.remainder.get(t):0}forEachItem(t,e){return this.items.forEach(t,e),this}forEachRemain(t,e){return this.remainder.forEach(t,e),this}destroy(){this.items.clear(),this.remainder.clear(),this.result=null,this._restartFlag=!1}get totalRemainderCount(){return null===this._totalRemainderCount&&(this._totalRemainderCount=r(this.remainder)),this._totalRemainderCount}startGen(){this.remainder.clear();for(const[t,e]of this.items)e>0&&this.remainder.set(t,e);return this.mode===e.random&&(this._totalRemainderCount=null),this._restartFlag=!1,this}addRemainItem(t,s=1,i){return 0===s||(r=(this.remainder.has(t)?this.remainder.get(t):0)+s,void 0!==i&&r>i&&(r=i),r>0?this.remainder.set(t,r):this.remainder.delete(t),this.mode===e.shuffle&&this.reload&&0===this.remainder.size&&(this._restartFlag=!0)),this;var r}getRndItem(){let t=null,e=(this.rnd?this.rnd.frac():Math.random())*this.totalRemainderCount;for(const[s,i]of this.remainder)if(e-=i,e<=0){t=s;break}return t}}}));
