!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).rexgashapon={})}(this,(function(t){"use strict";var e;(e=t.Mode||(t.Mode={}))[e.shuffle=0]="shuffle",e[e.random=1]="random";let s=function(t){if(Array.isArray(t))t.length=0;else for(let e in t)delete t[e]},i=function(t,e){var i=Array.isArray(t);if(void 0===e?e=i?[]:{}:s(e),i){e.length=t.length;for(let s=0,i=t.length;s<i;s++)e[s]=t[s]}else for(let s in t)e[s]=t[s];return e};t.Gashapon=class{constructor(t){void 0===t&&(t={}),this.resetFromJSON(t)}resetFromJSON({mode:e=t.Mode.shuffle,reload:s=!0,items:r={},result:h=null,remainder:n,rnd:a}){return null==this.items&&(this.items={}),null==this.remainder&&(this.remainder={}),null==this._list&&(this._list=[]),this.setMode(e),this.setReload(s),this.setRND(a),this.items=i(r,this.items),this._list.length=0,this.result=h,this._restartFlag=!0,this._restartFlag&&this.startGen(),n&&(this.remainder=i(n,this.remainder)),this}toJSON(){return{mode:this.mode,reload:this.reload,rnd:this.rnd,items:this.items,remainder:this.remainder,result:this.result,restart:!0}}setMode(e){return"string"==typeof e&&(e=t.Mode[e]),this.mode===e||(this.mode=e,this._restartFlag=!0),this}setReload(t=!0){return this.reload=t,this}setRND(t){return this.rnd=t,this}setItem(t,e){return this.items[t]===e||(this.items[t]=e,this._restartFlag=!0),this}setItems(t={}){return this.items=i(t,this.items),this}removeItem(t){return this.items.hasOwnProperty(t)?(delete this.items[t],this._restartFlag=!0,this):this}removeAllItems(){return s(this.items),this._restartFlag=!0,this}addItem(e,s=1){return this.items.hasOwnProperty(e)||(this.items[e]=0),this.items[e]+=s,this._restartFlag||(this.mode===t.Mode.shuffle?this.addRemainItem(e,s):this.resetItemList(this.remainder)),this}putItemBack(e,s=1){return this.mode===t.Mode.random||this._restartFlag||!this.items.hasOwnProperty(e)||(this.remainder.hasOwnProperty(e)||(this.remainder[e]=0),this.addRemainItem(e,s,this.items[e])),this}next(e){let s=null;return this._restartFlag&&this.startGen(),void 0===e?this.mode===t.Mode.shuffle?(this.resetItemList(this.remainder),s=this.getRndItem(this._list),this.addRemainItem(s,-1)):s=this.getRndItem(this._list):this.remainder.hasOwnProperty(e)?(s=e,this.mode===t.Mode.shuffle&&this.addRemainItem(e,-1)):s=null,this.result=s,s}getItems(){return this.items}getRemain(){return this.remainder}getItemCount(t){return this.items.hasOwnProperty(t)?this.items[t]:0}getRemainCount(t){return this.remainder.hasOwnProperty(t)?this.remainder[t]:0}forEachItem(t,e){let s=this.items;for(let i in s){let r;if(r=e?t.call(e,i,s[i]):t(i,s[i]),r)break}return this}forEachRemain(t,e){let s=this.remainder;for(let i in s){let r;if(r=e?t.call(e,i,s[i]):t(i,s[i]),r)break}return this}destroy(){s(this.items),s(this.remainder),s(this._list),this.result=null,this._restartFlag=!1}startGen(){for(let t in this.remainder)this.items.hasOwnProperty(t)||delete this.remainder[t];for(let t in this.items){let e=this.items[t];e>0&&(this.remainder[t]=e)}return this.mode===t.Mode.random&&this.resetItemList(this.remainder),this._restartFlag=!1,this}resetItemList(t){this._list.length=0;let e=0;for(let s in t){let i=t[s];i>0&&(e+=i)}for(let s in t){let i=t[s];i>0&&this._list.push([s,i/e])}return this}addRemainItem(e,s=1,i){return 0===s||(this.remainder.hasOwnProperty(e)||(this.remainder[e]=0),this.remainder[e]+=s,void 0!==i&&this.remainder[e]>i&&(this.remainder[e]=i),this.remainder[e]<=0&&delete this.remainder[e],this.mode===t.Mode.shuffle&&this.reload&&function(t){if(Array.isArray(t))return 0===t.length;for(let e in t)return!1;return!0}(this.remainder)&&(this._restartFlag=!0)),this}getRndItem(t){let e,s=this.rnd?this.rnd.frac():Math.random(),i=null;for(let r=0,h=t.length;r<h;r++)if(e=t[r],s-=e[1],s<0){i=e[0];break}return i}}}));
